#! /usr/bin/env sh

check_distfile() {
	if ! test -f "$PWD/Distfile"; then
		return 1
	fi
	return 0
}

setup_workdir() {
	WORK="$(mktemp -d -p "$PWD" --suffix=.work)"
	DIST="$(mktemp -d -p "$PWD" --suffix=.dist)"
	BOOT="$(mktemp -d -p "$PWD" --suffix=.boot)"
	ln -sf "$(basename $WORK)" "$PWD/work"
	ln -sf "$(basename $DIST)" "$PWD/dist"
	ln -sf "$(basename $BOOT)" "$PWD/boot"
}

clean_workdir() {
	grep -qs "$WORK" "/proc/mounts" || rm -r -f "$WORK"
}

main() {
	setup_workdir
	build
	clean_workdir
}

if check_distfile; then
	. "$PWD/Distfile"
fi

main "$@"
