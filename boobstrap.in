#! /bin/sh -

lddtree() {
	echo "$1"

	for dep in $(ldd "$1" | grep -o '/.* '); do
		lddtree "$dep"
	done
}

pkgadd() {
	CHROOT="/"

	# NOTABUG
	# behavior like original pkgadd
	while test "$2"; do
		case "$1" in
			"--root"|"-r") CHROOT="$2" ; shift ;;
			*) echo "invalid option $1" ; return 1 ;;
		esac
		shift
	done

	name="${1}"
	name="${name##*/}"
	name="${name%%.pkg*}"
	name="${name%%\#*}"

	version="${1}"
	version="${version##*/}"
	version="${version%%.pkg*}"
	version="${version##*\#}"

	echo "$name" >> "$CHROOT/var/lib/pkg/db"			|| return 1
	echo "$version" >> "$CHROOT/var/lib/pkg/db"			|| return 1
	tar -xpvf "$1" \
		--xattrs-include="*.*" \
		--numeric-owner \
		--directory "$CHROOT" >> "$CHROOT/var/lib/pkg/db"	|| return 1
	echo "" >> "$CHROOT/var/lib/pkg/db"				|| return 1
}

mkbootstrap() {
	case "$1" in
		"import") shift ; importroot "$@" ;;
		"export") shift ; exportroot "$@" ;;
		"crux_gnulinux") shift ; cruxstrap "$@" ;;
		"archlinux_gnulinux"|"arch_gnulinux") shift ; pacstrap "$@" ;;
		"debian_gnulinux") shift ; debootstrap "$@" ;;
	esac
}

importroot() {
	DIR=""

	while test "$1"; do
		case "$1" in
			*)
				if test "$DIR" = ""; then
					DIR="$1"
				fi
				;;
		esac
		shift
	done

	if test -d "$DIR"; then
		cd "$DIR"
		cpio --extract --make-directories --format "newc" --quiet
		cd "$OLDPWD"
	else
		echo "no such directory '$DIR'" >&2
	fi
}

exportroot() {
	DIR=""

	while test "$1"; do
		case "$1" in
			*)
				if test "$DIR" = ""; then
					DIR="$1"
				fi
				;;
		esac
		shift
	done

	if test -d "$DIR"; then
		cd "$DIR"
		find . -print0 | cpio --create --format "newc" --null --quiet
		cd "$OLDPWD"
	else
		echo "no such directory '$DIR'" >&2
	fi
}

cruxstrap() {
	CHROOT=""
	PORTS=""
	PACKAGES=""
	INSTALL=""

	while test "$1"; do
		case "$1" in
			"--ports-dir") PORTS="$PORTS $2" ; shift ;;
			*)
				if test "$CHROOT" = ""; then
					CHROOT="$1"
				else
					PACKAGES="$PACKAGES $1"
				fi
				;;
		esac
		shift
	done

	for dir in $PORTS; do
		for prt in "$dir/"*; do
			if test "$PACKAGES" = ""; then
				INSTALL="$INSTALL $prt"
			else
				for pkg in $PACKAGES; do
					if test -f "$pkg"; then
						INSTALL="$INSTALL $pkg"
					fi
					case "$prt" in
						*"/$pkg") INSTALL="$INSTALL $prt" ;;
						*"/$pkg#"*) INSTALL="$INSTALL $prt" ;;
					esac
				done
			fi
		done
	done

	mkdir -p "$CHROOT/var/lib/pkg" || return 1
	touch "$CHROOT/var/lib/pkg/db" || return 1

	for prt in $INSTALL; do
		pkgadd --root "$CHROOT" "$prt"
		case "$?" in
			"0") continue ;;
			*) return 1 ;;
		esac
	done
}

mkinitramfs() {
	CHROOT=""
	IMAGE=""
	IS_STANDALONE=""
	IS_OVERLAY=""
	OVERLAYS=""
	COMMAND=""

	while test "$1"; do
		case "$1" in
			"--output") IMAGE="$(realpath $2)" ; shift ;;
			"--standalone") IS_STANDALONE="yes" ;;
			"--overlay") IS_OVERLAY="yes" ; OVERLAYS="$OVERLAYS $2" ; shift ;;
			"--command") COMMAND="$2" ; shift ;;
			"--squashfs-xz") COMMAND="mksquashfs \${SOURCE} \${DESTINATION} -b $((1024 * 1024)) -comp xz -Xdict-size 100%" ;;
			*)
				if test "$CHROOT" = ""; then
					CHROOT="$1"
				fi
				;;
		esac
		shift
	done

	if test "$CHROOT" = ""; then
		CHROOT="."
	fi

	if test "$IS_STANDALONE" = "yes"; then
		IS_OVERLAY="no"
	fi

	if test "$IS_OVERLAY" = "yes"; then
		case "$COMMAND" in
			"") COMMAND="cp -a \${SOURCE} \${DESTINATION}" ;;
		esac

		for dir in "proc" "sys" "dev" "run" "merged" "overlay" "overlays"; do
			mkdir -p $CHROOT/$dir
		done

		for dev in "console" "tty" "tty1" "null"; do
			cp -a "/dev/$dev" "$CHROOT/dev/$dev"
		done

		for bin in "sh" "switch_root" "mount" "umount" "mkdir" "rmdir" "mv"; do
			for dep in $(lddtree $(which $bin)); do
				if test -f "$CHROOT$dep"; then
					continue
				fi
				install -D "$dep" "$CHROOT$dep"
			done
		done

		get_config_init > "$CHROOT/init"

		chmod +x "$CHROOT/init"

		NUM=0
		for overlay in $OVERLAYS; do
			NUM="$(($NUM + 10))"
			SOURCE="$overlay"
			DESTINATION="$CHROOT/overlays/$NUM-$(basename $overlay)"
			eval "$COMMAND"
			case "$?" in
				"0") continue ;;
				*) return 1 ;;
			esac
		done

	fi

	cd "$CHROOT"
	case "$IMAGE" in
		""|"-") find . -print0 | cpio -0o -H "newc" ;;
		*) find . -print0 | cpio -0o -H "newc" > "$IMAGE" ;;
	esac
	cd "$OLDPWD"
}

mkbootisofs() {
	DIR=""
	IMAGE=""

	while test "$1"; do
		case "$1" in
			"--output") IMAGE="$2" ; shift ;;
			*)
				if test "$DIR" = ""; then
					DIR="$1"
				fi
				;;
		esac
		shift
	done

	if test "$DIR" = ""; then
		DIR="."
	fi

	if test -d "$DIR/boot"; then
		mkdir "$DIR/boot/grub"
		get_config_grub_cfg > "$DIR/boot/grub/grub.cfg"
	fi

	grub-mkstandalone \
		--format="i386-pc" \
		--output="$DIR/boot/grub/grub.raw" \
		--install-modules="linux16 linux normal iso9660 biosdisk memdisk test search" \
		--modules="linux16 linux normal iso9660 biosdisk memdisk test search" \
		--locales="" \
		--fonts="" \
		--themes="" \
		"/boot/grub/grub.cfg=$DIR/boot/grub/grub.cfg"

	cat "$GRUB_i386_CDBOOT" "$DIR/boot/grub/grub.raw" > "$DIR/boot/grub/bios.img"

	grub-mkstandalone \
		--format="x86_64-efi" \
		--output="$DIR/boot/grub/grub.efi" \
		--modules="" \
		--locales="" \
		--fonts="" \
		--themes="starfield" \
		"/boot/grub/grub.cfg=$DIR/boot/grub/grub.cfg" \
		"/boot/grub/anyfont.pf2=$GRUB_FONT_ANYFONT"

	truncate -s "10MB" "$DIR/boot/grub/uefi.img"
	mkdosfs "$DIR/boot/grub/uefi.img"
	mkdir "$DIR/uefi"
	mount "$DIR/boot/grub/uefi.img" "$DIR/uefi"
	mkdir "$DIR/uefi/EFI"
	mkdir "$DIR/uefi/EFI/BOOT"
	cp "$DIR/boot/grub/grub.efi" "$DIR/uefi/EFI/BOOT/BOOTX64.EFI"
	umount "$DIR/uefi"
	rmdir "$DIR/uefi"

	xorriso -as "mkisofs" \
		-iso-level 3 \
		-full-iso9660-filenames \
		--grub2-boot-info \
		--grub2-mbr "$GRUB_i386_HYBRID" \
		--boot-catalog-hide \
		-eltorito-boot "boot/grub/bios.img" \
		-no-emul-boot \
		-boot-load-size 4 \
		-boot-info-table \
		-eltorito-alt-boot \
		-e "boot/grub/uefi.img" \
		-no-emul-boot \
		-append_partition 2 "0xEF" "$DIR/boot/grub/uefi.img" \
		-graft-points \
		-quiet \
		-output - \
		"$DIR"
}

boobstrap_build() {
	SHARE_DIR="/usr/share"
	SHARE_DIR="/mnt/boobstrap"

	TEMPLATE="default"
	TIMEOUT="0"
	COMMAND=""
	INSTALL=""

	ISO=""
	DIR=""

	while test "$1"; do
		case "$1" in
			"--template") TEMPLATE="$2" ; shift ;;
			"--timeout") TIMEOUT="$2" ; shift ;;
			*"="*) INSTALL="$INSTALL $1" ;;
			"--") shift ; COMMAND="$@" ;;
		esac
		shift
	done

	if test "$DIR" = ""; then
		DIR="$(mktemp -d -p $PWD)"
	fi

	echo "#! /bin/sh -" > "$DIR/post-install"
	chmod +x "$DIR/post-install"

	for i in $INSTALL; do
		src="${i##*=}"
		dst="$DIR/configure/${i%%=*}"
		install -D "$src" "$dst"
	done

	if test -f "$SHARE_DIR/bootstrap-templates/$TEMPLATE"; then
		sh -c "$SHARE_DIR/bootstrap-templates/$TEMPLATE $DIR"
	fi
}

boobstrap_run() {
	boobstrap_build "$@"
}

main() {
	PROGNAME="${0##*/}"

	if test "$PROGNAME" = "boobstrap"; then

		PROGNAME="$1"

		if test "$2"; then
			shift
		fi

		case "$PROGNAME" in
			"build") boobstrap_build "$@" ;;
			"run") boobstrap_run "$@" ;;
			"start") boobstrap_start "$@" ;;
			"stop") boobstrap_stop "$@" ;;
			"list") boobstrap_list "$@" ;;
			"--help"|"-h") rtfm ;;
		esac

	fi

	case "$PROGNAME" in
		"mkbootstrap") mkbootstrap "$@" ;;
		"mkinitramfs") mkinitramfs "$@" ;;
		"mkbootisofs") mkbootisofs "$@" ;;
	esac
}

rtfm() {
	cat <<"EOF"
WUT?
EOF
}

get_config_init() {
	cat <<"EOF"
#! /bin/sh -

mount -t proc none /proc

mount -t sysfs none /sys

mount -t devtmpfs devtmpfs /dev

mount -t tmpfs none /run

mount -t tmpfs tmpfs /merged

mount -t tmpfs tmpfs /overlay

lowerdir="/overlay/lower"
upperdir="/overlay/upper"
workdir="/overlay/work"

mkdir -p $lowerdir
mkdir -p $upperdir
mkdir -p $workdir

for overlay in /overlays/*; do

	if test -d "$overlay"; then

		mv -f $overlay/* "/merged"

	else
		overlay_mount="/overlay/${overlay##*/}"

		lowerdir="$overlay_mount:$lowerdir"

		mkdir -p $overlay_mount

		mount -t squashfs -o ro $overlay $overlay_mount
	fi

done

if test "$lowerdir" = "/overlay/lower"; then
	echo
else
	mount -t overlay -o lowerdir="$lowerdir",upperdir="$upperdir",workdir="$workdir" overlay /merged
fi

umount /proc
umount /sys
umount /dev
umount /run

exec switch_root /merged /sbin/init
EOF
}

get_config_grub_cfg() {
	cat <<"EOF"
function load_video {
if [ x$feature_all_video_module = xy ]; then
insmod all_video
else
insmod efi_gop
insmod efi_uga
insmod vbe
insmod vga
fi
}
if loadfont $prefix/anyfont.pf2; then
set gfxmode=auto
load_video
insmod gfxterm
terminal_output gfxterm
set gfxpayload=keep
insmod png
set theme="$prefix/themes/starfield/theme.txt"
fi
set color_normal=cyan/blue
set menu_color_normal=black/light-gray
set menu_color_highlight=white/cyan
set timeout=3
menuentry "GNU/Linux" {
search --no-floppy --file --set root /boot/vmlinuz
linux /boot/vmlinuz
initrd /boot/initrd
}
EOF
}

preflight_checks() {
	case "$(id -u)" in
		"0") ;;
		*)
			echo "must be run with root priveleges"
			return 1
			;;
	esac

	for dep in "grub-mkstandalone" "mkdosfs" "xorriso"; do
		which "$dep" 1>"/dev/null" 2>"/dev/null"
		case "$?" in
			"0") ;;
			*)
				echo "check for:"
				echo "* which"
				echo "* dosfstools"
				echo "* xorriso"
				echo "* grub2"
				echo "* grub2-efi"
				echo "* squashfs-tools (optional)"
				return 1
				;;
		esac
	done

	for dir in "/usr/lib/grub/i386-pc" "/lib/grub/i386-pc"; do
		if test -f "$dir/cdboot.img"; then
			GRUB_i386_CDBOOT="$dir/cdboot.img"
			GRUB_i386_HYBRID="$dir/boot_hybrid.img"
		fi
	done

	if test "$GRUB_i386_CDBOOT" = ""; then
		echo "cdboot.img none found, install grub-pc-bin or something."
		echo "or specify file: env GRUB_i386_CDBOOT=./cdboot.img $0"
		exit 1
	fi

	if test "$GRUB_i386_HYBRID" = ""; then
		echo "boot_hybrid.img none found, install grub-pc-bin or something."
		echo "or specify file: env GRUB_i386_HYBRID=./boot_hybrid.img $0"
		exit 1
	fi

	for font in "/usr/lib/grub/fonts/"*".pf2" "/lib/grub/fonts/"*".pf2" "/usr/share/grub/"*".pf2"; do
		if test -f "$font"; then
			GRUB_FONT_ANYFONT="$font"
		fi
	done
}

preflight_checks || exit 1

main "$@"
